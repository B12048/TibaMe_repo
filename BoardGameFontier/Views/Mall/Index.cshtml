@section Styles {
    <style>
        .product-card {
            border: none;
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .product-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .product-img {
            aspect-ratio: 1/1;
            width: 100%;
            object-fit: cover;
            border-bottom: 1px solid #eee;
        }

        .card-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }

        .price {
            font-size: 1.1rem;
            font-weight: bold;
            color: #e63946;
        }
    </style>
}

<div class="container-fluid">
    <div class="row mt-3">
        <div class="col-3">
            <partial name="~/Views/Shared/Partials/_CommunityLeftSidebar.cshtml" />
        </div>
        <div id="vue" class="container col-9 mt-4">
            <h1 class="mb-4 text-center">歡迎來到BGF商城</h1>

            <!-- 篩選關鍵字 -->
            <div class="mb-4">
                <div class="form-floating">
                    <input type="text" class="form-control" id="filterInput" placeholder="輸入關鍵字" v-model="keyword">
                    <label for="filterInput">篩選關鍵字</label>
                </div>
            </div>

            <!---VueComponets--->
            <mall-index v-if="currentView==='Index'" 
                       :merchandises="merchandises" 
                       :isLoading="isLoading" 
                       v-on:go-detail="goDetail"></mall-index>

            <mall-detail v-if="currentView==='Detail'" 
                        :item="selectedItem" 
                        v-on:back="goIndex"
                        v-on:goecpay="goEcPay"></mall-detail>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var app = Vue.createApp({
            data(){
                return{
                    isLoading:true,
                    merchandises:[],
                    currentView:'Index',
                    selectedItem:null,
                }
            },
            methods:{
                getMech(){
                    this.isLoading=true;
                    fetch(`/api/mall/getmerchandises`).then(response=>response.json()).then(data=>this.merchandises=data).finally(()=>{this.isLoading=false})
                },
                goDetail(item){
                    this.selectedItem = item;
                    this.currentView = "Detail";
                    history.pushState({ view: "Detail" }, "", "#detail");
                },
                goIndex(item){
                    this.selectedItem=null;
                    this.currentView="Index"
                },
                 async goEcPay() {
                    var formData = new URLSearchParams();
                    formData.append("MerchantID", "2000132");
                    formData.append("RqHeader", JSON.stringify({ Timestamp: "2025-08-17T12:00:00Z", Revision: "1.0.0" }));
                    formData.append("Data", JSON.stringify({ MerchantTradeNo: "TEST123", RtnCode: 1, RtnMsg: "OK" }));
                    var res = await fetch("/api/mall/aa", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: formData.toString()
                    });
                    var data = await res.text();
                    console.log(data); // "1|OK"
                    // data.paymentUrl: 後端返回的付款頁面網址
                    // window.location.href = data.paymentUrl;
                }
            },
            mounted(){
                this.getMech();
                 window.addEventListener("popstate", (event) => {
                        if(event.state){
                            if(event.state.view === "Detail"){
                                this.currentView = "Detail";
                            }else{
                                this.currentView = "Index";
                            }
                        }else{
                            // 如果 state 是 null，可能是第一次進入網站
                            this.currentView = "Index";
                        }
                    });
            }
        });
        //商城首頁Component
        app.component("mall-index",{
            props:["merchandises","isLoading"],
            emits:["godetail"],
            template:`
            <div class="row g-4">
                <template v-if="isLoading">
                    <!-- 載入中示意 -->
                    <div class="col-12 col-md-6 col-lg-4" v-for="i in 10" :key="i">
                        <div class="card">
                            <div class="card-body text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
                <template v-else>
                    <div class="col-12 col-md-6 col-lg-4" v-for="item in merchandises" :key="item.id" v-on:click="$emit('go-detail',item)">
                        <div class="card product-card h-100 shadow-sm">
                            <img :src="item.coverURL" class="card-img-top product-img" />
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-name">{{ item.zhtName }}</h5>
                                <h6 class="text-muted">{{ item.engName }}</h6>
                                <p class="text-secondary small mt-2 flex-grow-1">{{ item.intro }}</p>
                                <div class="mt-auto d-flex justify-content-between align-items-center">
                                    <span class="price">NT$ {{ item.price }}</span>
                                    <button class="btn btn-info"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cart4" viewBox="0 0 16 16">
                                      <path d="M0 2.5A.5.5 0 0 1 .5 2H2a.5.5 0 0 1 .485.379L2.89 4H14.5a.5.5 0 0 1 .485.621l-1.5 6A.5.5 0 0 1 13 11H4a.5.5 0 0 1-.485-.379L1.61 3H.5a.5.5 0 0 1-.5-.5M3.14 5l.5 2H5V5zM6 5v2h2V5zm3 0v2h2V5zm3 0v2h1.36l.5-2zm1.11 3H12v2h.61zM11 8H9v2h2zM8 8H6v2h2zM5 8H3.89l.5 2H5zm0 5a1 1 0 1 0 0 2 1 1 0 0 0 0-2m-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0m9-1a1 1 0 1 0 0 2 1 1 0 0 0 0-2m-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0"/>
                                    </svg>加入購物車</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
            `
        });
        //商品詳情Componet
        app.component("mall-detail",{
            props:["item"],
            emits:["back","goecpay"],
            template:`
                <button class="btn btn-outline-primary mb-3" v-on:click="$emit('back')">← 返回列表</button>
             <div class="card shadow p-4">
                <div class="row">
                    <div class="col-md-6">
                        <img :src="item.coverURL" class="img-fluid rounded" />
                    </div>
                    <div class="col-md-6">
                        <h2>{{ item.zhtName }}</h2>
                        <h5 class="text-muted">{{ item.engName }}</h5>
                        <p class="mt-3">{{ item.intro }}</p>
                        <p class="price">NT$ {{ item.price }}</p>
                        <button class="btn btn-secondary" v-on:click="$emit('goecpay')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bag-fill" viewBox="0 0 16 16">
                          <path d="M8 1a2.5 2.5 0 0 1 2.5 2.5V4h-5v-.5A2.5 2.5 0 0 1 8 1m3.5 3v-.5a3.5 3.5 0 1 0-7 0V4H1v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V4z"/>
                        </svg>立即購買</button>
                        <button class="btn btn-info"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cart4" viewBox="0 0 16 16">
                          <path d="M0 2.5A.5.5 0 0 1 .5 2H2a.5.5 0 0 1 .485.379L2.89 4H14.5a.5.5 0 0 1 .485.621l-1.5 6A.5.5 0 0 1 13 11H4a.5.5 0 0 1-.485-.379L1.61 3H.5a.5.5 0 0 1-.5-.5M3.14 5l.5 2H5V5zM6 5v2h2V5zm3 0v2h2V5zm3 0v2h1.36l.5-2zm1.11 3H12v2h.61zM11 8H9v2h2zM8 8H6v2h2zM5 8H3.89l.5 2H5zm0 5a1 1 0 1 0 0 2 1 1 0 0 0 0-2m-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0m9-1a1 1 0 1 0 0 2 1 1 0 0 0 0-2m-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0"/>
                        </svg>加入購物車</button>
                    </div>
                </div>
            </div>
            `
        });
        app.mount("#vue");
    </script>
}